// Aivo Platform - Comprehensive Prisma Schema
// Comprehensive schema for special education AI platform
// Includes: Multi-tenancy, IEP management, AI models, Phase 1 features

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// TENANT AND ORGANIZATION MODELS
// ================================

model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  domain      String?  @unique
  region      String   // Region: US, CA, UK, AU, etc.
  timezone    String   @default("UTC")
  settings    Json?    // Tenant-specific settings
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relationships
  districts     District[]
  schools       School[]
  users         User[]
  subscriptions Subscription[]

  // Multi-tenant isolation indexes
  @@index([slug])
  @@index([domain])
  @@map("tenants")
}

model District {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  code        String?   @unique
  address     Json?     // Address object
  contactInfo Json?     // Contact information
  settings    Json?     // District-specific settings
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relationships
  tenant      Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schools     School[]
  users       User[]

  @@index([tenantId])
  @@map("districts")
}

model School {
  id          String    @id @default(cuid())
  tenantId    String
  districtId  String?
  name        String
  code        String?   @unique
  type        String    // elementary, middle, high, k12
  address     Json?     // Address object
  contactInfo Json?     // Contact information
  settings    Json?     // School-specific settings
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relationships
  tenant        Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  district      District?  @relation(fields: [districtId], references: [id])
  users         User[]
  classrooms    Classroom[]
  ieps          IEP[]
  assessments   Assessment[]

  @@index([tenantId])
  @@index([districtId])
  @@map("schools")
}

model Classroom {
  id          String    @id @default(cuid())
  schoolId    String
  name        String
  gradeLevel  String    // K, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12
  subject     String?   // math, english, science, social_studies
  capacity    Int       @default(30)
  settings    Json?     // Classroom-specific settings
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Relationships
  school      School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachers    User[] @relation("ClassroomTeachers")
  students    User[] @relation("ClassroomStudents")

  @@index([schoolId, gradeLevel])
  @@map("classrooms")
}



// ================================
// USER MANAGEMENT MODELS
// ================================

model User {
  id            String    @id @default(cuid())
  tenantId      String
  email         String?   @unique
  phoneNumber   String?   @unique
  firstName     String
  lastName      String
  displayName   String?
  avatar        String?
  role          String    // learner, parent, teacher, district_admin, platform_admin
  status        String    @default("active") // active, inactive, suspended
  lastLoginAt   DateTime?
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)
  
  // MFA settings
  mfaEnabled    Boolean   @default(false)
  mfaSecret     String?   // TOTP secret
  backupCodes   String[]  // Encrypted backup codes
  
  // Profile information
  dateOfBirth   DateTime?
  grade         String?   // For students: K, 1, 2, ..., 12
  disabilities  Json?     // Array of disability classifications
  
  // IEP and special needs
  hasIEP        Boolean   @default(false)
  has504Plan    Boolean   @default(false)
  
  // Learning preferences and accessibility
  learningStyle Json?     // visual, auditory, kinesthetic preferences
  accessibility Json?     // accessibility settings and accommodations
  
  // Focus baseline metrics (for students)
  focusBaseline Json?     // Baseline attention and focus metrics
  
  // Audit fields
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete support

  // Organizational relationships
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  district      District? @relation(fields: [districtId], references: [id])
  school        School?   @relation(fields: [schoolId], references: [id])
  districtId    String?
  schoolId      String?
  
  // Multi-role relationships
  teacherClassrooms     Classroom[] @relation("ClassroomTeachers")
  studentClassrooms     Classroom[] @relation("ClassroomStudents")
  parentRelations       ParentStudentRelation[] @relation("ParentUser")
  childRelations        ParentStudentRelation[] @relation("StudentUser")
  
  // IEP relationships
  studentIEPs           IEP[] @relation("StudentIEP")
  teamMemberIEPs        IEPTeamMember[]
  
  // Assessment relationships
  createdAssessments    Assessment[] @relation("AssessmentCreator")
  assignedAssessments   AssessmentAssignment[]
  assessmentAttempts    AssessmentAttempt[]
  
  // AI relationships
  personalAIModel       PersonalAIModel?
  aiConversations       AIConversation[]
  
  // Session management
  sessions              UserSession[]
  
  // Audit and consent
  consentRecords        ConsentRecord[]
  
  // Phase 1 Features relationships
  // Focus Guardian
  focusSessionsAsStudent    FocusSession[] @relation("FocusSessionStudent")
  focusSessionsAsTeacher    FocusSession[] @relation("FocusSessionTeacher")
  
  // Game Generation
  gameSessionsAsStudent     GameSession[] @relation("GameSessionStudent")
  gameSessionsAsTeacher     GameSession[] @relation("GameSessionTeacher")
  
  // Homework Helper
  homeworkSessionsAsStudent HomeworkSession[] @relation("HomeworkSessionStudent")
  homeworkSessionsAsTeacher HomeworkSession[] @relation("HomeworkSessionTeacher")
  
  // Writing Pad
  writingDocumentsAsStudent WritingDocument[] @relation("WritingDocumentStudent")
  writingDocumentsAsTeacher WritingDocument[] @relation("WritingDocumentTeacher")
  writingComments           WritingComment[] @relation("WritingCommentAuthor")
  
  // Analytics and reporting
  studentProfile            StudentProfile?
  dailyFocusSummaries       DailyFocusSummary[]
  weeklyProgressReports     WeeklyProgressReport[]

  @@index([tenantId, role])
  @@index([email])
  @@index([role, status])
  @@map("users")
}

model ParentStudentRelation {
  id             String    @id @default(cuid())
  parentId       String
  studentId      String
  relationship   String    // parent, guardian, foster, etc.
  isPrimary      Boolean   @default(false)
  isEmergency    Boolean   @default(false)
  canPickup      Boolean   @default(true)
  receiveNotifications Boolean @default(true)
  contactMethod  String    @default("email")
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relationships
  parent         User @relation("ParentUser", fields: [parentId], references: [id], onDelete: Cascade)
  student        User @relation("StudentUser", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
  @@map("parent_student_relations")
}

model UserSession {
  id              String    @id @default(cuid())
  userId          String
  sessionToken    String    @unique
  refreshToken    String?   @unique
  deviceId        String?
  ipAddress       String?
  userAgent       String?
  isActive        Boolean   @default(true)
  expiresAt       DateTime
  lastActivityAt  DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model ConsentRecord {
  id          String    @id @default(cuid())
  userId      String
  type        String    // ConsentType enum
  granted     Boolean
  grantedBy   String?   // Parent/Guardian ID
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  grantedAt   DateTime
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("consent_records")
}

// ================================
// ASSESSMENT MODELS
// ================================

model Assessment {
  id                    String    @id @default(cuid())
  title                 String
  description           String?
  type                  String    // AssessmentType enum
  subject               String    // Subject enum
  gradeLevel            String    // GradeLevel enum
  totalPoints           Int       @default(0)
  timeLimit             Int?      // minutes
  attemptsAllowed       Int       @default(1)
  showFeedback          Boolean   @default(true)
  showCorrectAnswers    Boolean   @default(false)
  randomizeQuestions    Boolean   @default(false)
  randomizeOptions      Boolean   @default(false)
  isAdaptive            Boolean   @default(false)
  passingScore          Int?
  schoolId              String
  districtId            String?
  createdBy             String
  dueDate               DateTime?
  availableFrom         DateTime  @default(now())
  availableUntil        DateTime?
  status                String    @default("draft")
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  // Relationships
  school                School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  creator               User @relation("AssessmentCreator", fields: [createdBy], references: [id])
  questions             AssessmentQuestion[]
  assignments           AssessmentAssignment[]
  attempts              AssessmentAttempt[]

  @@map("assessments")
}

model AssessmentQuestion {
  id                String    @id @default(cuid())
  assessmentId      String
  type              String    // QuestionType enum
  subject           String    // Subject enum
  gradeLevel        String    // GradeLevel enum
  difficultyLevel   String    // DifficultyLevel enum
  standardIds       String[]  // Array of curriculum standard IDs
  questionText      String
  questionMedia     Json?     // Media object
  options           Json?     // Array of options for multiple choice
  correctAnswer     Json?     // Correct answer(s)
  rubric            Json?     // Rubric for scoring
  points            Int       @default(1)
  timeLimit         Int?      // seconds
  accommodations    Json?     // Accommodations object
  aiGenerated       Boolean   @default(false)
  sequence          Int       @default(0)
  isActive          Boolean   @default(true)
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  assessment        Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  responses         AssessmentResponse[]

  @@map("assessment_questions")
}

model AssessmentAssignment {
  id            String    @id @default(cuid())
  assessmentId  String
  studentId     String
  assignedBy    String
  assignedAt    DateTime  @default(now())
  dueDate       DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  status        String    @default("assigned") // assigned, started, completed, graded
  accommodations Json?    // Student-specific accommodations
  notes         String?

  // Relationships
  assessment    Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  student       User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, studentId])
  @@map("assessment_assignments")
}

model AssessmentAttempt {
  id            String    @id @default(cuid())
  assessmentId  String
  studentId     String
  attemptNumber Int
  sessionId     String?
  startedAt     DateTime  @default(now())
  submittedAt   DateTime?
  timeSpent     Int       @default(0) // seconds
  score         Float?
  percentage    Float?
  passed        Boolean?
  feedback      String?
  gradedBy      String?
  gradedAt      DateTime?
  flaggedForReview Boolean @default(false)
  accommodationsUsed String[]
  aiInsights    Json?
  metadata      Json?

  // Relationships
  assessment    Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  student       User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  responses     AssessmentResponse[]

  @@map("assessment_attempts")
}

model AssessmentResponse {
  id            String    @id @default(cuid())
  attemptId     String
  questionId    String
  answer        Json      // Student's answer
  timeSpent     Int       @default(0) // seconds
  isCorrect     Boolean?
  pointsEarned  Float?
  feedback      String?
  flagged       Boolean   @default(false)
  sequence      Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  attempt       AssessmentAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question      AssessmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("assessment_responses")
}

// ================================
// CURRICULUM MODELS
// ================================

model CurriculumStandard {
  id                String    @id @default(cuid())
  code              String    @unique
  title             String
  description       String
  framework         String    // CurriculumFramework enum
  region            String    // Region enum
  country           String
  state             String?
  subject           String    // Subject enum
  gradeLevel        String    // GradeLevel enum
  domain            String
  cluster           String?
  subCluster        String?
  learningObjectives String[]
  prerequisiteIds   String[]  // IDs of prerequisite standards
  masteryLevel      Int       @default(1)
  bloomsLevel       String
  cognitiveComplexity String
  tags              String[]
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("curriculum_standards")
}

// ================================
// AI MODELS
// ================================

model AIModel {
  id                String    @id @default(cuid())
  name              String
  description       String
  type              String    // AIModelType enum
  provider          String    // ModelProvider enum
  version           String
  status            String    @default("training") // ModelStatus enum
  capabilities      String[]
  supportedSubjects String[]  // Subject enum values
  supportedGrades   String[]  // GradeLevel enum values
  maxTokens         Int?
  temperature       Float?
  topP              Float?
  frequencyPenalty  Float?
  presencePenalty   Float?
  stopSequences     String[]
  systemPrompt      String?
  safetySettings    Json
  metadata          Json?
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deployedAt        DateTime?
  lastUsedAt        DateTime?

  // Relationships
  personalModels    PersonalAIModel[]
  conversations     AIConversation[]
  generatedContent  AIGeneratedContent[]

  @@map("ai_models")
}

model PersonalAIModel {
  id                  String    @id @default(cuid())
  studentId           String    @unique
  baseModelId         String
  name                String
  personalityTraits   Json      // PersonalityTraits object
  learningPreferences Json      // LearningPreferences object
  communicationStyle  Json      // CommunicationStyle object
  adaptations         Json      // Adaptations object
  performanceMetrics  Json      // PerformanceMetrics object
  trainingData        Json      // TrainingData object
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relationships
  student             User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  baseModel           AIModel @relation(fields: [baseModelId], references: [id])

  @@map("personal_ai_models")
}

model AIConversation {
  id            String    @id @default(cuid())
  studentId     String
  aiModelId     String
  sessionId     String
  context       Json      // Conversation context
  metadata      Json      // Conversation metadata
  isActive      Boolean   @default(true)
  endedAt       DateTime?
  endReason     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  student       User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  aiModel       AIModel @relation(fields: [aiModelId], references: [id])
  messages      AIMessage[]

  @@map("ai_conversations")
}

model AIMessage {
  id              String    @id @default(cuid())
  conversationId  String
  role            String    // user, assistant, system
  content         String
  metadata        Json      // Message metadata
  attachments     Json?     // Array of attachments
  feedback        Json?     // User feedback
  createdAt       DateTime  @default(now())

  // Relationships
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("ai_messages")
}

model AIGeneratedContent {
  id            String    @id @default(cuid())
  type          String    // Content type
  modelId       String
  subject       String    // Subject enum
  gradeLevel    String    // GradeLevel enum
  topic         String
  content       String
  metadata      Json      // Generation metadata
  usage         Json      // Usage statistics
  alignment     Json      // Curriculum alignment
  isApproved    Boolean   @default(false)
  reviewedBy    String?
  reviewedAt    DateTime?
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  model         AIModel @relation(fields: [modelId], references: [id])

  @@map("ai_generated_content")
}

// ================================
// IEP MODELS
// ================================

model IEP {
  id            String    @id @default(cuid())
  studentId     String
  schoolId      String
  districtId    String?
  status        String    @default("draft") // IEPStatus enum
  studentInfo   Json      // Student information
  dates         Json      // IEP dates and timeline
  presentLevels Json      // Present levels of performance
  placement     Json      // LRE and placement information
  assessmentAccommodations Json // Assessment accommodations
  extendedSchoolYear Json? // ESY information
  transition    Json?     // Transition services (14+)
  parentInput   String?
  studentInput  String?
  createdBy     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  approvedAt    DateTime?
  approvedBy    String?
  deletedAt     DateTime?

  // Relationships
  student       User @relation("StudentIEP", fields: [studentId], references: [id], onDelete: Cascade)
  school        School @relation(fields: [schoolId], references: [id])
  goals         IEPGoal[]
  services      IEPService[]
  teamMembers   IEPTeamMember[]
  meetings      IEPMeeting[]
  behaviorPlan  BehaviorInterventionPlan?

  @@map("ieps")
}

model IEPGoal {
  id                    String    @id @default(cuid())
  iepId                 String
  domain                String    // Goal domain
  subject               String?   // Subject enum
  description           String
  measurableAnnualGoal  String
  specific              String
  measurable            Json      // Measurable criteria
  achievable            Boolean   @default(true)
  relevant              String
  timeBound             String
  objectives            Json      // Array of objectives
  progressReporting     Json      // Progress reporting details
  progress              Json      // Array of progress reports
  status                String    @default("active")
  masteryDate           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relationships
  iep                   IEP @relation(fields: [iepId], references: [id], onDelete: Cascade)

  @@map("iep_goals")
}

model IEPService {
  id            String    @id @default(cuid())
  iepId         String
  type          String    // ServiceType enum
  description   String
  frequency     Json      // Service frequency
  duration      Json      // Service duration
  location      String
  locationDetails String?
  provider      Json      // Service provider information
  startDate     DateTime
  endDate       DateTime
  progressNotes Json      // Array of progress notes
  status        String    @default("active")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  iep           IEP @relation(fields: [iepId], references: [id], onDelete: Cascade)

  @@map("iep_services")
}

model IEPTeamMember {
  id                String    @id @default(cuid())
  iepId             String
  userId            String?
  name              String
  role              String    // UserRole or other role
  title             String
  qualifications    String[]
  relationship      String?
  participationType String
  attended          Boolean   @default(false)
  signedDate        DateTime?
  comments          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  iep               IEP @relation(fields: [iepId], references: [id], onDelete: Cascade)
  user              User? @relation(fields: [userId], references: [id])

  @@map("iep_team_members")
}

model IEPMeeting {
  id              String    @id @default(cuid())
  iepId           String
  type            String    // Meeting type
  scheduledDate   DateTime
  actualDate      DateTime?
  duration        Int?      // minutes
  location        String
  method          String    // in_person, virtual, hybrid
  attendees       Json      // Array of attendee information
  agenda          String[]
  discussionPoints String[]
  decisions       Json      // Array of decisions
  parentNotification Json   // Array of notification records
  parentRights    Json      // Parent rights information
  minutes         String?
  followUpActions Json      // Array of follow-up actions
  nextMeetingDate DateTime?
  nextMeetingType String?
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  iep             IEP @relation(fields: [iepId], references: [id], onDelete: Cascade)

  @@map("iep_meetings")
}

model BehaviorInterventionPlan {
  id                String    @id @default(cuid())
  iepId             String    @unique
  targetBehaviors   Json      // Array of target behaviors
  replacementBehaviors Json   // Array of replacement behaviors
  interventions     Json      // Intervention strategies
  crisisProcedures  Json?     // Crisis procedures
  dataCollection    Json      // Data collection methods
  progressData      Json      // Array of progress data
  reviewDate        DateTime
  effectiveDate     DateTime
  lastReviewDate    DateTime?
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  iep               IEP @relation(fields: [iepId], references: [id], onDelete: Cascade)

  @@map("behavior_intervention_plans")
}

// ================================
// SUBSCRIPTION MODELS
// ================================

model SubscriptionPlan {
  id              String    @id @default(cuid())
  name            String
  tier            String    // SubscriptionTier enum
  description     String
  features        Json      // FeatureSet object
  pricing         Json      // Array of regional pricing
  trialDays       Int?
  trialFeatures   Json?     // Trial FeatureSet
  isActive        Boolean   @default(true)
  availableRegions String[] // Array of regions
  targetCustomers String[]  // Array of customer types
  contractTerms   Json?     // Contract terms
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  subscriptions   Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                String    @id @default(cuid())
  tenantId          String
  planId            String
  customerId        String    // School, District, or Individual ID
  status            String    @default("active") // SubscriptionStatus enum
  billingCycle      String    // BillingCycle enum
  currency          String
  amount            Int       // in cents
  startDate         DateTime
  endDate           DateTime?
  trialStart        DateTime?
  trialEnd          DateTime?
  canceledAt        DateTime?
  cancelationReason String?
  currentPeriodStart DateTime
  currentPeriodEnd  DateTime
  currentUsage      Json      // Usage statistics
  nextBillingDate   DateTime?
  lastBillingDate   DateTime?
  discount          Json?     // Discount information
  addOns            Json      // Array of add-ons
  contract          Json?     // Contract information
  metadata          Json?
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  tenant            Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan @relation(fields: [planId], references: [id])
  invoices          Invoice[]
  usageRecords      UsageRecord[]

  @@map("subscriptions")
}

model Invoice {
  id              String    @id @default(cuid())
  subscriptionId  String
  customerId      String
  invoiceNumber   String    @unique
  status          String    // PaymentStatus enum
  currency        String
  subtotal        Int       // in cents
  taxAmount       Int
  discountAmount  Int
  total           Int
  amountDue       Int
  amountPaid      Int
  items           Json      // Array of line items
  invoiceDate     DateTime
  dueDate         DateTime
  paidAt          DateTime?
  paymentMethod   Json?     // Payment method information
  billingAddress  Json      // Billing address
  taxId           String?
  taxExempt       Boolean   @default(false)
  collectionMethod String   @default("charge_automatically")
  daysOverdue     Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model UsageRecord {
  id              String    @id @default(cuid())
  subscriptionId  String
  customerId      String
  metric          String    // Usage metric type
  quantity        Float
  unit            String
  recordedAt      DateTime
  periodStart     DateTime
  periodEnd       DateTime
  billable        Boolean   @default(true)
  unitPrice       Float?
  totalCost       Float?
  source          String    @default("automatic")
  metadata        Json?
  createdAt       DateTime  @default(now())

  // Relationships
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("usage_records")
}

// ================================
// PHASE 1 FEATURES MODELS
// ================================

// Focus Guardian Models
model FocusSession {
  id                String    @id @default(cuid())
  studentId         String
  teacherId         String?
  subject           String?   // Subject enum
  activityType      String    // lesson, assignment, assessment, free_time
  duration          Int       // planned duration in minutes
  actualDuration    Int?      // actual duration in minutes
  startedAt         DateTime  @default(now())
  endedAt           DateTime?
  status            String    @default("active") // active, paused, completed, interrupted
  
  // Focus metrics
  focusScore        Float?    // 0-100 focus score
  distractionCount  Int       @default(0)
  attentionSpan     Int?      // longest continuous attention in minutes
  fatigueLevel      String?   // low, medium, high
  
  // Settings and consent
  parentalConsent   Boolean   @default(false)
  consentedBy       String?   // Parent/Guardian ID
  monitoringLevel   String    @default("basic") // basic, detailed, comprehensive
  interventionLevel String    @default("gentle") // gentle, moderate, assertive
  
  // Analytics data
  analytics         Json?     // Detailed analytics object
  metadata          Json?     // Additional session metadata
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  student           User @relation("FocusSessionStudent", fields: [studentId], references: [id], onDelete: Cascade)
  teacher           User? @relation("FocusSessionTeacher", fields: [teacherId], references: [id])
  events            FocusEvent[]
  interventions     FocusIntervention[]

  @@index([studentId, startedAt])
  @@index([status, startedAt])
  @@map("focus_sessions")
}

model FocusEvent {
  id                String    @id @default(cuid())
  sessionId         String
  type              String    // attention_lost, attention_regained, distraction_detected, fatigue_detected, interaction
  severity          String    @default("low") // low, medium, high, critical
  confidence        Float     // AI confidence score (0-1)
  
  // Event data
  description       String?
  duration          Int?      // event duration in seconds
  triggers          String[]  // array of trigger types
  context           Json?     // contextual information
  
  // Timestamps
  detectedAt        DateTime  @default(now())
  acknowledgedAt    DateTime?
  resolvedAt        DateTime?
  
  // Metadata
  deviceInfo        Json?     // device and browser information
  environmentData   Json?     // environment context
  
  createdAt         DateTime  @default(now())

  // Relationships
  session           FocusSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, detectedAt])
  @@index([type, detectedAt])
  @@map("focus_events")
}

model FocusIntervention {
  id                String    @id @default(cuid())
  sessionId         String
  type              String    // reminder, break_suggestion, game_break, breathing_exercise, stretching
  strategy          String    // gentle, motivational, gamified, educational
  
  // Intervention details
  title             String
  description       String
  content           Json?     // intervention content (text, images, activities)
  duration          Int?      // suggested duration in minutes
  
  // Execution
  triggeredAt       DateTime  @default(now())
  startedAt         DateTime?
  completedAt       DateTime?
  skippedAt         DateTime?
  effectiveness     String?   // effective, somewhat_effective, not_effective
  
  // Student response
  studentResponse   Json?     // student's response and feedback
  followUpNeeded    Boolean   @default(false)
  
  // Metadata
  aiGenerated       Boolean   @default(true)
  personalizedFor   String?   // personalization context
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  session           FocusSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, triggeredAt])
  @@index([type, effectiveness])
  @@map("focus_interventions")
}

// Game Generation Models
model GameTemplate {
  id                String    @id @default(cuid())
  name              String
  description       String
  category          String    // math, reading, science, logic, memory, creativity
  type              String    // puzzle, quiz, matching, sorting, drawing, story
  
  // Age and grade targeting
  minAge            Int
  maxAge            Int
  gradeLevel        String    // GradeLevel enum
  subject           String    // Subject enum
  
  // Game configuration
  difficulty        String    @default("medium") // easy, medium, hard, adaptive
  estimatedDuration Int       // estimated play time in minutes
  maxPlayers        Int       @default(1)
  isMultiplayer     Boolean   @default(false)
  
  // Template structure
  structure         Json      // game structure and rules
  contentSlots      Json      // dynamic content slots
  scoringRubric     Json      // scoring and feedback rules
  adaptationRules   Json      // difficulty adaptation rules
  
  // Metadata
  tags              String[]
  isActive          Boolean   @default(true)
  popularity        Int       @default(0)
  
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  games             GameSession[]

  @@index([category, gradeLevel])
  @@index([subject, difficulty])
  @@map("game_templates")
}

model GameSession {
  id                String    @id @default(cuid())
  templateId        String
  studentId         String
  teacherId         String?
  
  // Session details
  title             String
  description       String?
  status            String    @default("created") // created, started, paused, completed, abandoned
  
  // Game content (generated by AI)
  generatedContent  Json      // AI-generated game content
  gameState         Json      // current game state
  playerProgress    Json      // player progress and achievements
  
  // Timing
  startedAt         DateTime?
  completedAt       DateTime?
  estimatedDuration Int       // estimated duration in minutes
  actualDuration    Int?      // actual play time in minutes
  
  // Scoring and results
  score             Int?      // final score
  maxScore          Int?      // maximum possible score
  percentage        Float?    // percentage score
  performanceLevel  String?   // excellent, good, satisfactory, needs_improvement
  
  // Learning outcomes
  skillsAssessed    String[]  // skills being assessed
  masteryLevels     Json      // mastery levels for different skills
  learningObjectives String[] // learning objectives addressed
  
  // Feedback and analytics
  aiAnalysis        Json?     // AI analysis of performance
  feedback          String?   // personalized feedback
  recommendations   String[]  // recommended next steps
  
  // Metadata
  metadata          Json?     // additional game metadata
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  template          GameTemplate @relation(fields: [templateId], references: [id])
  student           User @relation("GameSessionStudent", fields: [studentId], references: [id], onDelete: Cascade)
  teacher           User? @relation("GameSessionTeacher", fields: [teacherId], references: [id])
  results           GameResult[]

  @@index([studentId, createdAt])
  @@index([status, startedAt])
  @@map("game_sessions")
}

model GameResult {
  id                String    @id @default(cuid())
  sessionId         String
  
  // Result details
  completedAt       DateTime  @default(now())
  score             Int
  maxScore          Int
  percentage        Float
  timeTaken         Int       // time in seconds
  
  // Performance breakdown
  skillBreakdown    Json      // performance by skill area
  questionResults   Json      // individual question/challenge results
  mistakes          Json      // analysis of mistakes made
  strengths         Json      // identified strengths
  improvements      Json      // areas for improvement
  
  // Learning analytics
  difficultyPath    Json      // difficulty progression during game
  engagementLevel   String    // high, medium, low
  frustrationPoints Json      // points where student struggled
  successMoments    Json      // moments of success and breakthrough
  
  // AI insights
  aiInsights        Json      // AI analysis and insights
  personalizedTips  String[]  // personalized learning tips
  nextSteps         String[]  // recommended next activities
  
  createdAt         DateTime  @default(now())

  // Relationships
  session           GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([completedAt])
  @@map("game_results")
}

// Homework Helper Models
model HomeworkSession {
  id                String    @id @default(cuid())
  studentId         String
  teacherId         String?
  
  // Problem details
  subject           String    // Subject enum
  topic             String
  gradeLevel        String    // GradeLevel enum
  problemType       String    // math_problem, essay, reading_comprehension, science_experiment
  
  // Problem content
  problemStatement  String
  problemImages     Json?     // array of image URLs
  attachments       Json?     // array of file attachments
  
  // Session management
  status            String    @default("active") // active, completed, paused, abandoned
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  
  // AI Analysis
  initialAnalysis   Json?     // AI analysis of the problem
  difficultyLevel   String?   // easy, medium, hard
  estimatedTime     Int?      // estimated time in minutes
  requiredSkills    String[]  // skills needed to solve
  
  // Solution tracking
  solutionSteps     Json      // structured solution steps
  currentStep       Int       @default(0)
  hintsUsed         Int       @default(0)
  maxHints          Int       @default(3)
  
  // Student work
  studentWork       Json      // student's work and progress
  finalAnswer       Json?     // student's final answer
  confidence        String?   // student's confidence level
  
  // Feedback and results
  feedback          String?   // AI-generated feedback
  isCorrect         Boolean?  // whether the answer is correct
  score             Float?    // numerical score if applicable
  
  // Learning analytics
  strugglingAreas   String[]  // areas where student struggled
  strengths         String[]  // areas where student excelled
  recommendations   String[]  // personalized recommendations
  
  // Metadata
  metadata          Json?     // additional session metadata
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  student           User @relation("HomeworkSessionStudent", fields: [studentId], references: [id], onDelete: Cascade)
  teacher           User? @relation("HomeworkSessionTeacher", fields: [teacherId], references: [id])
  hints             HomeworkHint[]
  resources         HomeworkResource[]

  @@index([studentId, createdAt])
  @@index([subject, gradeLevel])
  @@map("homework_sessions")
}

model HomeworkHint {
  id                String    @id @default(cuid())
  sessionId         String
  stepNumber        Int
  
  // Hint details
  hintType          String    // conceptual, procedural, example, encouragement
  content           String
  explanation       String?
  examples          Json?     // array of examples
  
  // Interaction
  requestedAt       DateTime  @default(now())
  viewedAt          DateTime?
  helpful           Boolean?  // student feedback on helpfulness
  
  // AI generation
  aiGenerated       Boolean   @default(true)
  personalizedFor   String?   // personalization context
  difficulty        String    @default("appropriate") // too_easy, appropriate, too_hard
  
  createdAt         DateTime  @default(now())

  // Relationships
  session           HomeworkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, stepNumber])
  @@map("homework_hints")
}

model HomeworkResource {
  id                String    @id @default(cuid())
  sessionId         String?
  
  // Resource details
  title             String
  description       String
  type              String    // video, article, interactive, practice_problems, tutorial
  url               String?
  content           String?
  
  // Targeting
  subject           String    // Subject enum
  gradeLevel        String    // GradeLevel enum
  topics            String[]
  skills            String[]
  
  // Metadata
  duration          Int?      // estimated time to consume in minutes
  difficulty        String    @default("medium") // easy, medium, hard
  language          String    @default("en")
  isInteractive     Boolean   @default(false)
  
  // Quality and engagement
  rating            Float?    // average user rating
  engagementScore   Float?    // engagement metrics
  isRecommended     Boolean   @default(false)
  
  // Access control
  isPublic          Boolean   @default(true)
  requiresLogin     Boolean   @default(false)
  
  createdBy         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  session           HomeworkSession? @relation(fields: [sessionId], references: [id])

  @@index([subject, gradeLevel])
  @@index([type, isRecommended])
  @@map("homework_resources")
}

// Writing Pad Models
model WritingDocument {
  id                String    @id @default(cuid())
  studentId         String
  teacherId         String?
  
  // Document details
  title             String
  type              String    // essay, story, report, journal, poem, letter
  subject           String?   // Subject enum
  gradeLevel        String    // GradeLevel enum
  
  // Content
  content           String    @default("")
  wordCount         Int       @default(0)
  characterCount    Int       @default(0)
  
  // Assignment context
  prompt            String?   // writing prompt or assignment
  instructions      Json?     // specific instructions
  rubric            Json?     // grading rubric
  requirements      Json?     // requirements (min words, format, etc.)
  
  // Status and timing
  status            String    @default("draft") // draft, in_progress, submitted, graded
  startedAt         DateTime  @default(now())
  submittedAt       DateTime?
  dueDate           DateTime?
  
  // Collaboration
  isShared          Boolean   @default(false)
  shareSettings     Json?     // sharing settings and permissions
  collaborators     String[]  // array of user IDs
  
  // AI assistance
  aiAssistanceLevel String    @default("basic") // none, basic, moderate, comprehensive
  suggestionMode    String    @default("grammar") // grammar, style, content, all
  
  // Writing analytics
  writingTime       Int       @default(0) // total writing time in minutes
  revisionCount     Int       @default(0)
  pauseCount        Int       @default(0)
  deletionCount     Int       @default(0)
  
  // Feedback and scoring
  aiScore           Float?    // AI-generated overall score
  readabilityScore  Float?    // readability analysis
  grammarScore      Float?    // grammar accuracy
  creativityScore   Float?    // creativity assessment
  
  // Metadata
  metadata          Json?     // additional document metadata
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  student           User @relation("WritingDocumentStudent", fields: [studentId], references: [id], onDelete: Cascade)
  teacher           User? @relation("WritingDocumentTeacher", fields: [teacherId], references: [id])
  feedback          WritingFeedback[]
  revisions         WritingRevision[]
  comments          WritingComment[]

  @@index([studentId, createdAt])
  @@index([status, dueDate])
  @@map("writing_documents")
}

model WritingFeedback {
  id                String    @id @default(cuid())
  documentId        String
  
  // Feedback details
  type              String    // grammar, style, content, structure, creativity
  category          String    // strength, suggestion, error, question
  
  // Content
  feedback          String
  suggestion        String?
  explanation       String?
  
  // Location in document
  startPosition     Int?      // character position
  endPosition       Int?      // character position
  selectedText      String?   // text being referenced
  
  // AI generation
  aiGenerated       Boolean   @default(true)
  confidence        Float?    // AI confidence score
  priority          String    @default("medium") // low, medium, high
  
  // Student interaction
  viewedAt          DateTime?
  acceptedAt        DateTime?
  dismissedAt       DateTime?
  helpful           Boolean?  // student feedback
  
  // Resolution
  resolved          Boolean   @default(false)
  resolvedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  document          WritingDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, type])
  @@index([aiGenerated, priority])
  @@map("writing_feedback")
}

model WritingRevision {
  id                String    @id @default(cuid())
  documentId        String
  
  // Revision details
  versionNumber     Int
  content           String
  changeDescription String?
  
  // Change tracking
  additions         Json?     // array of added text segments
  deletions         Json?     // array of deleted text segments
  modifications     Json?     // array of modified text segments
  
  // Timing
  createdAt         DateTime  @default(now())
  
  // Metadata
  wordCount         Int       @default(0)
  characterCount    Int       @default(0)
  metadata          Json?     // additional revision metadata

  // Relationships
  document          WritingDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, versionNumber])
  @@map("writing_revisions")
}

model WritingComment {
  id                String    @id @default(cuid())
  documentId        String
  authorId          String
  
  // Comment details
  content           String
  type              String    @default("general") // general, suggestion, question, praise
  
  // Location in document
  startPosition     Int?      // character position
  endPosition       Int?      // character position
  selectedText      String?   // text being commented on
  
  // Thread management
  parentCommentId   String?   // for replies
  isResolved        Boolean   @default(false)
  resolvedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  document          WritingDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  author            User @relation("WritingCommentAuthor", fields: [authorId], references: [id])
  parent            WritingComment? @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies           WritingComment[] @relation("CommentReplies")

  @@index([documentId, createdAt])
  @@index([authorId])
  @@map("writing_comments")
}

// Writing Prompt Templates
model WritingPrompt {
  id                String    @id @default(cuid())
  title             String
  description       String
  prompt            String
  
  // Targeting
  type              String    // creative, argumentative, narrative, expository, descriptive
  subject           String?   // Subject enum
  gradeLevel        String    // GradeLevel enum
  
  // Configuration
  difficulty        String    @default("medium") // easy, medium, hard
  estimatedTime     Int       // estimated writing time in minutes
  minWords          Int?      // minimum word count
  maxWords          Int?      // maximum word count
  
  // Content
  instructions      Json?     // detailed instructions
  examples          Json?     // example responses
  rubric            Json?     // evaluation rubric
  keywords          String[]  // relevant keywords
  
  // Metadata
  tags              String[]
  isActive          Boolean   @default(true)
  popularity        Int       @default(0)
  
  createdBy         String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([gradeLevel, subject])
  @@index([type, difficulty])
  @@map("writing_prompts")
}

// ================================
// ANALYTICS & REPORTING MODELS
// ================================

model DailyFocusSummary {
  id                String    @id @default(cuid())
  studentId         String
  date              DateTime  // Date for this summary
  
  // Focus metrics
  totalFocusTime    Int       // Total focus time in minutes
  averageFocusScore Float     // Average focus score (0-100)
  distractionCount  Int       // Total distractions
  breakCount        Int       // Total breaks taken
  
  // Subject breakdown
  subjectBreakdown  Json      // Focus metrics by subject
  
  // Time patterns
  bestFocusHour     Int?      // Hour of day with best focus (0-23)
  worstFocusHour    Int?      // Hour of day with worst focus (0-23)
  
  // Intervention effectiveness
  interventionCount Int       // Number of interventions
  gameBreakCount    Int       // Number of game breaks
  interventionEffect Float?   // Effectiveness score (0-1)
  
  // Recommendations
  recommendations   String[]  // AI-generated recommendations
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  student           User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([date])
  @@map("daily_focus_summaries")
}

model WeeklyProgressReport {
  id                    String    @id @default(cuid())
  studentId             String
  weekStart             DateTime  // Start of the week
  weekEnd               DateTime  // End of the week
  
  // Academic progress
  homeworkCompletion    Float     // Completion rate (0-1)
  averageScore          Float?    // Average homework/assessment score
  improvementAreas      String[]  // Areas needing improvement
  strengths             String[]  // Areas of strength
  
  // Focus progress
  focusImprovement      Float?    // Week-over-week focus improvement
  attentionSpanGrowth   Float?    // Attention span growth in minutes
  distractionReduction  Float?    // Reduction in distractions (percentage)
  
  // Engagement metrics
  gameEngagement        Float?    // Game engagement score (0-1)
  writingProductivity   Float?    // Writing productivity score
  sessionConsistency    Float?    // Consistency in session attendance
  
  // IEP goal progress (if applicable)
  iepGoalProgress       Json?     // Progress on IEP goals
  accommodationUsage    Json?     // Usage of accommodations
  
  // Parent/teacher notes
  teacherNotes          String?
  parentNotes           String?
  
  // AI insights
  aiInsights            Json      // AI-generated insights and trends
  recommendations       String[]  // Recommendations for next week
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relationships
  student               User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, weekStart])
  @@index([weekStart, weekEnd])
  @@map("weekly_progress_reports")
}

model StudentProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  
  // Demographics
  gradeLevel            String    // Current grade level
  ageGroup              String    // K-5, 6-8, 9-12
  
  // Curriculum and academic
  currentCurriculum     String?   // Curriculum framework
  primaryLanguage       String    @default("en")
  secondaryLanguages    String[]
  
  // Disability and special needs
  disabilityTypes       String[]  // Array of disability classifications
  iepActive             Boolean   @default(false)
  plan504Active         Boolean   @default(false)
  
  // IEP data storage
  iepGoals              Json?     // Current IEP goals
  accommodations        Json?     // Required accommodations
  modifications         Json?     // Required modifications
  servicesRequired      Json?     // Required services
  
  // Learning preferences
  learningStyle         Json      // Learning style preferences
  processingSpeed       String?   // slow, average, fast
  workingMemory         String?   // low, average, high
  attentionSpan         Int?      // Baseline attention span in minutes
  
  // Accessibility settings
  textSize              String    @default("medium") // small, medium, large, extra-large
  contrast              String    @default("normal") // normal, high
  audioSupport          Boolean   @default(false)
  visualSupport         Boolean   @default(false)
  motorSupport          Boolean   @default(false)
  
  // Focus baseline metrics
  baselineFocusScore    Float?    // Initial focus assessment score
  optimalSessionLength  Int?      // Optimal learning session length in minutes
  preferredBreakLength  Int?      // Preferred break length in minutes
  
  // Behavioral patterns
  bestFocusTimes        Json?     // Time periods when student focuses best
  commonDistractions    String[]  // Common distraction types
  motivators            String[]  // Things that motivate the student
  
  // Technology preferences
  preferredInputMethod  String    @default("keyboard") // keyboard, voice, touch
  assistiveTechnology   Json?     // Required assistive technology
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relationships
  user                  User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([gradeLevel, ageGroup])
  @@index([disabilityTypes])
  @@map("student_profiles")
}

// Add the missing relationship to User model for student profiles
// This would need to be added to the User model:
// studentProfile        StudentProfile?
// dailyFocusSummaries   DailyFocusSummary[]
// weeklyProgressReports WeeklyProgressReport[]

// ================================
// COMPOUND INDEXES FOR OPTIMIZATION
// ================================

// Note: Additional compound indexes for query optimization are defined
// within each model block above for better organization and maintenance.
// Common query patterns covered:
// - Multi-tenant isolation (tenantId indexes)
// - Time-based queries (date/timestamp indexes)  
// - Student-centric queries (studentId + date/subject)
// - Status and type filtering
// - Hierarchical relationships (school -> district -> tenant)